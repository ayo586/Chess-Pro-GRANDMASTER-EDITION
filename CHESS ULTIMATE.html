<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Grandmaster Chess Pro</title>
    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap');

        :root {
            --bg-dark: #0a0a0a;
            --surface: #141414;
            --accent: #3b82f6;
            --square-light: #ebecd0;
            --square-dark: #779556;
            --highlight: rgba(255, 255, 0, 0.3);
            --last-move: rgba(185, 202, 67, 0.6);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e5e5e5;
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100vh;
            height: 100svh;
        }

        .chess-container {
            display: grid;
            grid-template-columns: 1fr auto 320px;
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            height: 100%;
            align-items: center;
        }

        @media (max-width: 1200px) {
            .chess-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 0.5rem;
                padding: 0.5rem;
                justify-items: center;
                align-items: start;
                overflow-y: auto;
            }
        }

        .board-wrapper {
            position: relative;
            padding: 6px;
            background: #262626;
            border-radius: 4px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            touch-action: none;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: min(94vw, 75vh, 560px);
            height: min(94vw, 75vh, 560px);
            user-select: none;
            -webkit-user-select: none;
            transition: transform 0.5s ease-in-out;
        }

        .board.flipped { transform: rotate(180deg); }

        .square {
            aspect-ratio: 1/1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .square.light { background-color: var(--square-light); }
        .square.dark { background-color: var(--square-dark); }
        .square.selected { background-color: #f5f682 !important; }
        .square.last-move { background-color: #b9ca43 !important; }
        .square.check { background-image: radial-gradient(circle, #ff3b3b 0%, transparent 80%); }

        .piece {
            width: 100%;
            height: 100%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 10;
            pointer-events: none; 
        }

        .flipped .piece { transform: rotate(180deg); }

        .wp { background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg'); }
        .wr { background-image: url('https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg'); }
        .wn { background-image: url('https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg'); }
        .wb { background-image: url('https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg'); }
        .wq { background-image: url('https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg'); }
        .wk { background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg'); }
        .bp { background-image: url('https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg'); }
        .br { background-image: url('https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg'); }
        .bn { background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg'); }
        .bb { background-image: url('https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg'); }
        .bq { background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg'); }
        .bk { background-image: url('https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg'); }

        .hint-dot {
            width: 25%;
            height: 25%;
            background: rgba(0,0,0,0.15);
            border-radius: 50%;
        }

        .coord {
            position: absolute;
            font-size: 9px;
            font-weight: 700;
            color: rgba(0,0,0,0.25);
            pointer-events: none;
        }
        .square.dark .coord { color: rgba(255,255,255,0.2); }
        .coord-rank { left: 2px; top: 2px; }
        .coord-file { right: 2px; bottom: 2px; }

        .timer-active {
            background: #ffffff !important;
            color: #000000 !important;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        @media (max-width: 1200px) {
            .mobile-top { order: 1; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; }
            .board-wrapper { order: 2; }
            .mobile-bottom { order: 3; width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; }
            .side-panel { order: 4; width: 100%; max-width: 560px; }
        }

        .voice-settings {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 1rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>

    <!-- Username Dialog -->
    <div id="username-dialog" class="hidden fixed inset-0 z-[150] bg-black flex items-center justify-center p-4">
        <div class="max-w-xs w-full text-center space-y-6">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto flex items-center justify-center text-4xl shadow-2xl">
                <i class="fas fa-chess-knight"></i>
            </div>
            <div class="space-y-2">
                <h2 class="text-3xl font-black tracking-tighter uppercase">Identity</h2>
                <p class="text-zinc-500 text-sm font-medium">Choose your Grandmaster username</p>
            </div>
            <input type="text" id="username-input" class="w-full bg-zinc-900 border-2 border-zinc-800 rounded-2xl p-5 text-center text-xl font-bold focus:border-blue-600 outline-none text-white transition-all" placeholder="E.g. Magnus2026">
            <button onclick="saveUsername()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-5 rounded-2xl transition active:scale-95">
                START PLAYING
            </button>
        </div>
    </div>

    <!-- Main Menu Overlay -->
    <div id="main-menu" class="fixed inset-0 z-[100] bg-black flex items-center justify-center p-4 transition-opacity duration-300 overflow-y-auto">
        <div class="max-w-md w-full text-center space-y-6 py-10">
            <div class="flex items-center justify-center gap-2 mb-4">
                <span id="user-badge" class="bg-zinc-900 px-4 py-2 rounded-full border border-zinc-800 text-[10px] font-black tracking-widest text-zinc-400">
                    <i class="fas fa-user-circle mr-2 text-blue-500"></i> <span id="display-username">PLAYER</span>
                </span>
            </div>
            <div class="space-y-1">
                <h1 class="text-6xl font-black tracking-tighter text-white">CHESS<span class="text-blue-500">PRO</span></h1>
                <p class="text-zinc-500 font-semibold tracking-widest uppercase text-xs">Grandmaster Edition</p>
            </div>
            
            <div class="space-y-4">
                <div class="bg-zinc-900/50 border border-zinc-800 rounded-3xl p-6 space-y-4 shadow-2xl backdrop-blur-md">
                    <span class="block text-[10px] font-black text-zinc-500 uppercase tracking-[0.3em]">Online Play</span>
                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="setupOnline('host')" class="bg-blue-600 hover:bg-blue-500 text-white font-black py-5 rounded-2xl transition active:scale-95 flex items-center justify-center gap-3">
                            <i class="fas fa-satellite"></i> CREATE ROOM
                        </button>
                        <button onclick="showJoinDialog()" class="bg-zinc-800 hover:bg-zinc-700 text-white font-black py-5 rounded-2xl transition active:scale-95 flex items-center justify-center gap-3">
                            <i class="fas fa-door-open"></i> JOIN ROOM
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="initGame('ai')" class="flex flex-col items-center justify-center py-6 bg-zinc-900 border border-zinc-800 rounded-2xl hover:border-blue-500/50 transition active:scale-95">
                        <i class="fas fa-robot text-2xl text-blue-500 mb-2"></i>
                        <span class="font-black text-[10px] uppercase">vs AI</span>
                    </button>
                    <button onclick="initGame('multiplayer')" class="flex flex-col items-center justify-center py-6 bg-zinc-900 border border-zinc-800 rounded-2xl hover:border-emerald-500/50 transition active:scale-95">
                        <i class="fas fa-users text-2xl text-emerald-500 mb-2"></i>
                        <span class="font-black text-[10px] uppercase">Local</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Room Dialog -->
    <div id="join-dialog" class="hidden fixed inset-0 z-[110] bg-black/95 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-zinc-900 p-8 rounded-3xl border border-zinc-800 w-full max-w-xs text-center shadow-2xl">
            <h2 class="text-xl font-black mb-6 uppercase tracking-widest">Connect</h2>
            <input type="tel" id="join-code-input" maxlength="6" class="w-full bg-black border-2 border-zinc-800 rounded-2xl p-5 text-center text-4xl font-mono tracking-[0.2em] focus:border-blue-500 outline-none mb-6 text-white" placeholder="000000">
            <div class="flex gap-3">
                <button onclick="hideJoinDialog()" class="flex-1 bg-zinc-800 py-4 rounded-xl font-bold">Cancel</button>
                <button onclick="setupOnline('join')" class="flex-1 bg-blue-600 py-4 rounded-xl font-bold">Join</button>
            </div>
        </div>
    </div>

    <!-- Game UI -->
    <div class="chess-container opacity-0 transition-opacity duration-700" id="game-ui">
        
        <!-- Opponent Header -->
        <div class="mobile-top w-full lg:flex lg:flex-col lg:justify-center lg:h-full lg:py-8 lg:order-1">
            <div class="flex items-center gap-3 p-3 bg-zinc-900/80 rounded-2xl border border-zinc-800 shadow-lg min-w-[140px]">
                <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-xs border border-zinc-700 font-bold" id="p-black-avatar">B</div>
                <div>
                    <div class="font-black text-[10px] uppercase tracking-tighter leading-none" id="p-black">Opponent</div>
                    <div class="text-[9px] text-zinc-500 font-bold" id="p-black-sub">Black</div>
                </div>
            </div>
            <div id="timer-b" class="bg-zinc-900 px-6 py-2.5 rounded-2xl font-mono text-xl border border-zinc-800 text-zinc-500 shadow-inner">10:00</div>
        </div>

        <!-- Board -->
        <div class="board-wrapper lg:order-2">
            <div id="board" class="board"></div>
            <!-- Room Badge -->
            <div id="room-code-badge" class="hidden absolute -top-4 left-1/2 -translate-x-1/2 bg-blue-600 px-4 py-2 rounded-full text-[9px] font-black shadow-2xl border border-blue-400 z-50 tracking-widest">
                ID: <span id="display-code" class="font-mono">...</span>
            </div>
        </div>

        <!-- Player Footer (Mobile Only) -->
        <div class="mobile-bottom w-full lg:hidden">
            <div class="flex items-center gap-3 p-3 bg-zinc-900/80 rounded-2xl border border-zinc-800 shadow-lg min-w-[140px]">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs border border-blue-400 font-bold" id="p-white-avatar">W</div>
                <div>
                    <div class="font-black text-[10px] uppercase tracking-tighter leading-none" id="p-white">You</div>
                    <div class="text-[9px] text-zinc-500 font-bold">White</div>
                </div>
            </div>
            <div id="timer-w" class="bg-zinc-900 px-6 py-2.5 rounded-2xl font-mono text-xl border border-zinc-800 text-zinc-500 shadow-inner">10:00</div>
        </div>

        <!-- Side Panel -->
        <div class="side-panel flex flex-col gap-3 lg:order-3 lg:h-full lg:max-h-screen">
            <!-- Desktop Player Card -->
            <div class="hidden lg:flex items-center justify-between p-4 bg-zinc-900/80 rounded-2xl border border-zinc-800">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center border border-blue-400 font-bold" id="p-white-avatar-desk">W</div>
                    <div class="font-black text-xs uppercase" id="p-white-desk">You</div>
                </div>
                <div id="timer-w-desk" class="font-mono text-lg text-zinc-500">10:00</div>
            </div>

            <!-- Voice Settings Panel -->
            <div class="voice-settings space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-[10px] font-black uppercase tracking-widest text-blue-400"><i class="fas fa-volume-up mr-2"></i> Voice</span>
                    <label class="relative inline-flex items-center cursor-pointer scale-75">
                        <input type="checkbox" id="voice-toggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-zinc-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <select id="voice-select" class="w-full bg-zinc-950 border border-zinc-800 text-xs rounded-lg p-2 outline-none focus:border-blue-500"></select>
            </div>

            <!-- Match Status -->
            <div class="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl shadow-xl">
                <div class="flex items-center justify-between mb-2">
                    <span id="game-mode-tag" class="text-blue-500 text-[9px] font-black uppercase tracking-[0.2em]">VS AI</span>
                    <span id="check-alert" class="hidden text-red-500 text-[9px] font-black animate-pulse">CHECK</span>
                </div>
                <div id="status-text" class="text-xl font-black truncate leading-tight">White's Turn</div>
                <div id="captured-w" class="flex flex-wrap gap-1 mt-3 min-h-[16px]"></div>
                <div id="captured-b" class="flex flex-wrap gap-1 mt-1 min-h-[16px]"></div>
            </div>

            <!-- History -->
            <div class="bg-zinc-900 border border-zinc-800 rounded-2xl overflow-hidden flex flex-col min-h-[120px] lg:flex-grow shadow-2xl">
                <div class="bg-zinc-800/50 p-2.5 px-4 text-[9px] font-black text-zinc-500 border-b border-zinc-800 flex justify-between items-center tracking-widest">
                    <span>HISTORY</span>
                    <button onclick="location.reload()" class="bg-zinc-700 hover:bg-zinc-600 px-3 py-1 rounded-lg text-white transition active:scale-95 text-[10px]"><i class="fas fa-home"></i></button>
                </div>
                <div id="history-container" class="p-3 overflow-y-auto custom-scroll grid grid-cols-2 gap-x-4 content-start font-mono text-[10px] h-full bg-black/10"></div>
            </div>
        </div>
    </div>

    <!-- Promotion Modal -->
    <div id="promotion-dialog" class="hidden fixed inset-0 z-[200] bg-black/95 flex items-center justify-center p-4">
        <div class="bg-zinc-900 p-8 rounded-[40px] border border-zinc-800 shadow-2xl text-center w-full max-w-sm">
            <h3 class="text-xl font-black mb-8 uppercase tracking-widest text-white">Promote</h3>
            <div class="grid grid-cols-2 gap-4" id="promo-options"></div>
        </div>
    </div>

    <!-- Firebase & Chess System -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // mandatory Rule 1: Config
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'chess-pro-2026';
        const apiKey = ""; 
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const game = new Chess();
        const boardEl = document.getElementById('board');
        const statusText = document.getElementById('status-text');
        const historyContainer = document.getElementById('history-container');
        const voiceToggle = document.getElementById('voice-toggle');
        const voiceSelect = document.getElementById('voice-select');
        
        let user = null;
        let myUsername = "Player";
        let gameMode = 'ai'; 
        let onlineRole = null; 
        let roomCode = null;
        let roomRef = null;
        let lastMove = { from: null, to: null };
        let selectedSquare = null;
        let timers = { w: 600, b: 600 };
        let timerInterval = null;
        let isSyncing = false;

        const PIECE_VALUES = { p: 10, n: 30, b: 30, r: 50, q: 90, k: 900 };
        const VOICES = ["Zephyr", "Puck", "Charon", "Kore", "Fenrir", "Leda", "Orus", "Aoede", "Callirrhoe", "Autonoe", "Enceladus", "Iapetus", "Umbriel", "Algieba", "Despina", "Erinome", "Algenib", "Rasalgethi", "Laomedeia", "Achernar", "Alnilam", "Schedar", "Gacrux", "Pulcherrima", "Achird", "Zubenelgenubi", "Vindemiatrix", "Sadachbia", "Sadaltager", "Sulafat"];

        // Rule 3: Auth First
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, async (u) => {
            user = u;
            if (u) {
                // Check for profile
                const profileRef = doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'info');
                const snap = await getDoc(profileRef);
                if (snap.exists()) {
                    myUsername = snap.data().username;
                    updateIdentityUI();
                } else {
                    document.getElementById('username-dialog').classList.remove('hidden');
                }
            }
        });

        initAuth();

        window.saveUsername = async () => {
            const input = document.getElementById('username-input').value.trim();
            if (input.length < 2) return;
            myUsername = input;
            const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info');
            await setDoc(profileRef, { username: myUsername, createdAt: serverTimestamp() });
            document.getElementById('username-dialog').classList.add('hidden');
            updateIdentityUI();
        };

        function updateIdentityUI() {
            document.getElementById('display-username').textContent = myUsername.toUpperCase();
        }

        // Initialize Voices
        VOICES.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            if(name === "Kore") opt.selected = true;
            voiceSelect.appendChild(opt);
        });

        window.initGame = function(mode) {
            gameMode = mode;
            document.getElementById('main-menu').style.opacity = '0';
            setTimeout(() => document.getElementById('main-menu').style.display = 'none', 300);
            document.getElementById('game-ui').style.opacity = '1';
            document.getElementById('game-mode-tag').textContent = mode.toUpperCase();
            
            // Set Names for AI/Local
            if (mode === 'ai') {
                document.getElementById('p-black').textContent = "DEEPBLUE AI";
                document.getElementById('p-black-avatar').textContent = "AI";
            } else if (mode === 'multiplayer') {
                document.getElementById('p-black').textContent = "PLAYER 2";
                document.getElementById('p-black-avatar').textContent = "P2";
            }
            
            document.getElementById('p-white').textContent = myUsername.toUpperCase();
            document.getElementById('p-white-avatar').textContent = myUsername[0].toUpperCase();
            if(document.getElementById('p-white-desk')) document.getElementById('p-white-desk').textContent = myUsername;
            if(document.getElementById('p-white-avatar-desk')) document.getElementById('p-white-avatar-desk').textContent = myUsername[0].toUpperCase();

            resetGame();
        };

        window.showJoinDialog = () => document.getElementById('join-dialog').classList.remove('hidden');
        window.hideJoinDialog = () => document.getElementById('join-dialog').classList.add('hidden');

        window.setupOnline = async function(type) {
            if (!user) await initAuth();
            const codeInput = document.getElementById('join-code-input').value;
            if (type === 'join' && codeInput.length !== 6) return;

            roomCode = type === 'host' ? Math.floor(100000 + Math.random() * 900000).toString() : codeInput;
            roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode);

            try {
                if (type === 'host') {
                    await setDoc(roomRef, { 
                        fen: 'start', 
                        lastMove: null, 
                        players: { w: user.uid, b: null }, 
                        names: { w: myUsername, b: "Waiting..." },
                        status: 'waiting', 
                        lastUpdate: serverTimestamp() 
                    });
                    onlineRole = 'w';
                } else {
                    const snap = await getDoc(roomRef);
                    if (!snap.exists()) { alert("Invalid Code"); return; }
                    await updateDoc(roomRef, { 
                        'players.b': user.uid, 
                        'names.b': myUsername,
                        status: 'playing' 
                    });
                    onlineRole = 'b';
                }
                initOnlineGame();
            } catch (err) { alert("Connection Error"); }
        };

        function initOnlineGame() {
            gameMode = 'online';
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('join-dialog').classList.add('hidden');
            document.getElementById('game-ui').style.opacity = '1';
            document.getElementById('room-code-badge').classList.remove('hidden');
            document.getElementById('display-code').textContent = roomCode;
            if (onlineRole === 'b') boardEl.classList.add('flipped');
            
            onSnapshot(roomRef, (snap) => {
                if (!snap.exists()) return;
                const data = snap.data();
                
                // Sync Names
                document.getElementById('p-white').textContent = data.names.w.toUpperCase();
                document.getElementById('p-black').textContent = data.names.b.toUpperCase();
                document.getElementById('p-white-avatar').textContent = data.names.w[0].toUpperCase();
                document.getElementById('p-black-avatar').textContent = data.names.b[0].toUpperCase();
                
                if (data.fen !== game.fen() && data.fen !== 'start') {
                    isSyncing = true;
                    game.load(data.fen);
                    lastMove = data.lastMove || { from: null, to: null };
                    renderPieces();
                    isSyncing = false;
                }
                if (data.status === 'playing') startTimer();
            });
            resetGame();
        }

        // --- Voice Logic (Gemini TTS) ---
        async function speakMove(move) {
            if(!voiceToggle.checked) return;
            const pieceNames = { p: 'pawn', n: 'knight', b: 'bishop', r: 'rook', q: 'queen', k: 'king' };
            const turn = move.color === 'w' ? 'White' : 'Black';
            let msg = `${turn} `;
            if(move.flags.includes('k')) msg += "castles kingside";
            else if(move.flags.includes('q')) msg += "castles queenside";
            else {
                msg += `${pieceNames[move.piece]} to ${move.to}`;
                if(move.captured) msg += ` capturing ${pieceNames[move.captured]}`;
            }
            if(game.in_checkmate()) msg += ". Checkmate!";
            else if(game.in_check()) msg += ". Check!";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: msg }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceSelect.value } }
                            }
                        }
                    })
                });
                const result = await response.json();
                const inlineData = result.candidates?.[0]?.content?.parts?.[0]?.inlineData;
                if(!inlineData) return;
                const bytes = new Uint8Array(atob(inlineData.data).split("").map(c => c.charCodeAt(0)));
                const sampleRate = parseInt(inlineData.mimeType.split('rate=')[1]) || 24000;
                const audio = new Audio(URL.createObjectURL(pcmToWav(bytes, sampleRate)));
                audio.play();
            } catch (err) {}
        }

        function pcmToWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length);
            const view = new DataView(buffer);
            const writeString = (offset, string) => { for (let i=0; i<string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, 1, true); 
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmData.length, true);
            for (let i=0; i<pcmData.length; i++) view.setUint8(44 + i, pcmData[i]);
            return new Blob([view], { type: 'audio/wav' });
        }

        // --- Core Chess ---
        function createBoard() {
            boardEl.innerHTML = '';
            for (let i = 0; i < 64; i++) {
                const row = Math.floor(i / 8), col = i % 8;
                const sqName = String.fromCharCode(97 + col) + (8 - row);
                const sq = document.createElement('div');
                sq.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                sq.dataset.square = sqName;
                sq.addEventListener('click', e => { e.preventDefault(); handleSquareClick(sqName); });
                sq.insertAdjacentHTML('afterbegin', `<div class="coord coord-rank">${8-row}</div>`);
                sq.insertAdjacentHTML('afterbegin', `<div class="coord coord-file">${String.fromCharCode(97+col)}</div>`);
                boardEl.appendChild(sq);
            }
            renderPieces();
        }

        function renderPieces() {
            const squares = boardEl.querySelectorAll('.square');
            const turn = game.turn(), inCheck = game.in_check();
            squares.forEach(sq => {
                const name = sq.dataset.square, piece = game.get(name);
                sq.querySelectorAll('.piece, .hint-dot').forEach(el => el.remove());
                sq.classList.remove('selected', 'last-move', 'check');
                if (piece) {
                    const pDiv = document.createElement('div');
                    pDiv.className = `piece ${piece.color}${piece.type}`;
                    sq.appendChild(pDiv);
                    if (inCheck && piece.type === 'k' && piece.color === turn) sq.classList.add('check');
                }
                if (name === lastMove.from || name === lastMove.to) sq.classList.add('last-move');
                if (name === selectedSquare) sq.classList.add('selected');
            });
            if (selectedSquare) {
                game.moves({ square: selectedSquare, verbose: true }).forEach(m => {
                    const dot = document.createElement('div');
                    dot.className = 'hint-dot';
                    const target = boardEl.querySelector(`[data-square="${m.to}"]`);
                    if (target) target.appendChild(dot);
                });
            }
            updateStatus();
            updateHistoryUI();
            updateCapturedUI();
        }

        function handleSquareClick(square) {
            if (game.game_over() || (gameMode === 'online' && game.turn() !== onlineRole)) return;
            const piece = game.get(square);
            if (selectedSquare) {
                const moveData = { from: selectedSquare, to: square, promotion: 'q' };
                const move = game.move(moveData);
                if (move) {
                    if (move.flags.includes('p')) { game.undo(); showPromotion(moveData); }
                    else { commitMove(move); }
                    selectedSquare = null;
                } else {
                    selectedSquare = (piece && piece.color === game.turn()) ? square : null;
                }
            } else if (piece && piece.color === game.turn()) {
                selectedSquare = square;
            }
            renderPieces();
        }

        async function commitMove(move) {
            lastMove = { from: move.from, to: move.to };
            selectedSquare = null;
            renderPieces();
            startTimer();
            speakMove(move);
            if (gameMode === 'online' && !isSyncing && user) {
                try {
                    await updateDoc(roomRef, { fen: game.fen(), lastMove: lastMove, lastUpdate: serverTimestamp() });
                } catch (e) {}
            }
            if (gameMode === 'multiplayer') {
                if (game.turn() === 'b') boardEl.classList.add('flipped');
                else boardEl.classList.remove('flipped');
            }
            if (gameMode === 'ai' && game.turn() === 'b' && !game.game_over()) {
                setTimeout(makeAIMove, 500);
            }
        }

        function updateHistoryUI() {
            const hist = game.history();
            historyContainer.innerHTML = '';
            hist.forEach((move, i) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between p-1.5 border-b border-zinc-800 text-[10px] items-center';
                div.innerHTML = `<span class="text-zinc-600 font-bold">${Math.floor(i/2)+1}.</span> <span class="text-blue-400 font-black">${move}</span>`;
                historyContainer.appendChild(div);
            });
            historyContainer.scrollTop = historyContainer.scrollHeight;
        }

        function updateCapturedUI() {
            const hist = game.history({verbose: true});
            const captured = { w: [], b: [] };
            hist.forEach(m => { if(m.captured) captured[m.color === 'w' ? 'b' : 'w'].push(m.captured); });
            ['w', 'b'].forEach(color => {
                const el = document.getElementById(`captured-${color}`);
                el.innerHTML = '';
                captured[color].forEach(type => {
                    const p = document.createElement('div');
                    p.className = `piece ${color}${type} !w-4 !h-4 opacity-80`;
                    el.appendChild(p);
                });
            });
        }

        function updateStatus() {
            const turn = game.turn() === 'w' ? 'White' : 'Black';
            const over = game.game_over(), check = game.in_check();
            document.getElementById('check-alert').style.display = check ? 'block' : 'none';
            if (over) {
                stopTimer();
                statusText.textContent = game.in_checkmate() ? `${turn === 'White' ? 'Black' : 'White'} Wins!` : "Draw";
            } else {
                statusText.textContent = `${turn}'s Turn`;
                if (gameMode === 'online' && game.turn() !== onlineRole) statusText.innerHTML += ` <span class="text-zinc-500 text-[9px] loading-dots"> (WAIT)</span>`;
            }
            const activeTimer = game.turn() === 'w' ? 'timer-w' : 'timer-b';
            document.querySelectorAll('#timer-w, #timer-b, #timer-w-desk').forEach(el => el?.classList.remove('timer-active'));
            document.getElementById(activeTimer).classList.add('timer-active');
            if(activeTimer === 'timer-w' && document.getElementById('timer-w-desk')) document.getElementById('timer-w-desk').classList.add('text-white');
        }

        function resetGame() {
            game.reset();
            lastMove = { from: null, to: null };
            selectedSquare = null;
            timers = { w: 600, b: 600 };
            updateTimerDisplay();
            stopTimer();
            createBoard();
        }

        function startTimer() {
            if (timerInterval || game.game_over()) return;
            timerInterval = setInterval(() => {
                const t = game.turn();
                timers[t]--;
                if (timers[t] <= 0) { timers[t] = 0; stopTimer(); updateStatus(); }
                updateTimerDisplay();
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); timerInterval = null; }

        function updateTimerDisplay() {
            const fmt = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2, '0')}`;
            document.getElementById('timer-w').textContent = fmt(timers.w);
            document.getElementById('timer-b').textContent = fmt(timers.b);
            const deskW = document.getElementById('timer-w-desk');
            if (deskW) deskW.textContent = fmt(timers.w);
        }

        function makeAIMove() {
            const move = getBestMove(game, 2); 
            if (move) commitMove(game.move(move));
        }

        function getBestMove(game, depth) {
            const moves = game.moves();
            let bestVal = -Infinity, bestMove = moves[Math.floor(Math.random() * moves.length)];
            for (let m of moves) {
                game.move(m);
                let val = -minimax(game, depth-1, -Infinity, Infinity, false);
                game.undo();
                if (val > bestVal) { bestVal = val; bestMove = m; }
            }
            return bestMove;
        }

        function minimax(game, depth, alpha, beta, isMax) {
            if (depth === 0) return evaluateBoard(game.board());
            const moves = game.moves();
            if (isMax) {
                let best = -Infinity;
                for (let m of moves) {
                    game.move(m);
                    best = Math.max(best, minimax(game, depth-1, alpha, beta, !isMax));
                    game.undo();
                    alpha = Math.max(alpha, best);
                    if (beta <= alpha) break;
                }
                return best;
            } else {
                let best = Infinity;
                for (let m of moves) {
                    game.move(m);
                    best = Math.min(best, minimax(game, depth-1, alpha, beta, !isMax));
                    game.undo();
                    beta = Math.min(beta, best);
                    if (beta <= alpha) break;
                }
                return best;
            }
        }

        function evaluateBoard(board) {
            let total = 0;
            for (let r=0; r<8; r++) {
                for (let c=0; c<8; c++) {
                    const p = board[r][c];
                    if (p) total += (p.color === 'w' ? PIECE_VALUES[p.type] : -PIECE_VALUES[p.type]);
                }
            }
            return total;
        }

        function showPromotion(moveData) {
            const diag = document.getElementById('promotion-dialog'), opts = document.getElementById('promo-options'), turn = game.turn();
            opts.innerHTML = '';
            ['q', 'r', 'b', 'n'].forEach(type => {
                const btn = document.createElement('button');
                btn.className = 'bg-zinc-800 hover:bg-zinc-700 rounded-3xl p-6 transition flex flex-col items-center gap-3 active:scale-95 shadow-xl';
                btn.innerHTML = `<div class="piece ${turn}${type} !w-16 !h-16"></div><span class="text-[10px] uppercase font-black text-zinc-500 tracking-widest">${type}</span>`;
                btn.onclick = () => { moveData.promotion = type; commitMove(game.move(moveData)); diag.classList.add('hidden'); };
                opts.appendChild(btn);
            });
            diag.classList.remove('hidden');
        }

        createBoard();
    </script>
</body>
</html>